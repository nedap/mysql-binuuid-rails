version: v1.0
name: mysql-binuuid-rails
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804
global_job_config:
  prologue:
    commands:
      - checkout
      - sem-version ruby $(cat .ruby-version)
      - 'echo "gem: --no-document" > ~/.gemrc'
      - gem install bundler
      - bundle config set path 'vendor/bundle'
      - 'cache restore gemlock-$SEMAPHORE_GIT_BRANCH,gemlock-main'
      - 'cache restore gems-$SEMAPHORE_GIT_BRANCH-$(checksum Gemfile.lock),gems-$SEMAPHORE_GIT_BRANCH,gems-main'
blocks:
  - name: install
    task:
      jobs:
        - name: install dependencies
          commands:
            - bundle update --retry 3
            - cache delete gemlock-$SEMAPHORE_GIT_BRANCH
            - cache store gemlock-$SEMAPHORE_GIT_BRANCH Gemfile.lock
            - cache store gems-$SEMAPHORE_GIT_BRANCH-$(checksum Gemfile.lock) vendor/bundle
  - name: run specs
    task:
      prologue:
        commands:
          - sem-service start mysql
          - bundle update rails
      jobs:
        - name: run tests
          commands:
            - bundle exec rake
          matrix:
            - env_var: RAILS_VERSION
              values:
                - 5.0.7.2
                - 5.1.7
                - 5.2.5
                - 6.0.3.6
                - 6.1.0
                - 6.1.1
                - 6.1.2.1
                - 6.1.3.1
